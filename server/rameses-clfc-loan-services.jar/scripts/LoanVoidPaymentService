import com.rameses.common.*;
import com.rameses.annotations.*;
import com.rameses.services.extended.*;

class LoanVoidPaymentService extends ActiveListService
{
	@Env
	def env;

	@ActiveDB(value="void_payment")
	def em;

	@Service("CustomerService")
	def customerSvc;

	@Service("DateService")
	def dateSvc;

	@ProxyMethod
	public def getNodes( params ) {
		return [
			[caption: 'PENDING', state: 'PENDING', name: 'pending', filetype: 'voidrequest'],
			[caption: 'APPROVED', state: 'APPROVED', name: 'approved', filetype: 'voidrequest']
		]
	}

	@ProxyMethod
	public def getColumns( params ) {
		return [
			[name: 'state', caption: 'State'],
			[name: 'txncode', caption: 'Txncode'],
			[name: 'route.area', caption: 'Route Area'],
			[name: 'loanapp.appno', caption: 'App. No.'],
			[name: 'borrower.name', caption: 'Borrower'],
			[name: 'collector.name', caption: 'Requested By'],
			[name: 'reason', caption: 'Reason']
		]
	}

	void beforeList( Object data ) {
		data.state = (data.state? data.state : '%');
	}

	@ProxyMethod
	public def create( params ) {
		params.state = 'PENDING';
		params.dtfiled = dateSvc.serverDate;
		params.filedby = (env.NAME? env.NAME : 'NOT IDENTIFIED');
		em.create(params);
		return open(params)
	}

	@ProxyMethod
	public def approve( params ) {
		params.dtapproved = dateSvc.serverDate;
		params.approvedby = (env.NAME? env.NAME : 'NOT IDENTIFIED');
		em.update(params, "approve");
		em.changeStateApproved(params);
		return params;
	}

	@ProxyMethod
	public def open( params ) {
		if (!params.txncode) throw new Exception("Please specify txncode.");

		if (params.txncode == 'FIELD') {
			return em.findFieldVoidRequestById(params);
		} else if (params.txncode == 'ONLINE') {
			return em.findOnlineVoidRequestById(params);
		}
	}

	@ProxyMethod
	public def openCustomer( params ) {
		def customer = customerSvc.open(params);
		return [address: customer.address, objid: customer.objid, name: customer.name];
	}
}