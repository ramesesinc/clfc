import com.rameses.common.*;
import com.rameses.annotations.*;
import com.rameses.server.common.*;

class DevicePostingService
{
	@ActiveDB(value="batch_collectionsheet")
	def batch_collectionsheet;

	@ActiveDB(value="void_payment")
	def void_payment;

	@Service("DeviceLoanBillingService")
	def device_billing;

	@ProxyMethod
	public void postPayment( params ) {
		if (!params.payment) throw new Exception("Please specify payment.");
		postCollectionSheet(params);

		def itm = batch_collectionsheet.read(params.payment, "payment");
		if (!itm) {
			def cs = batch_collectionsheet.read([objid: params.sessionid]);
			if (!cs) throw new Exception("Collection sheet does not exist or has already been deleted.");
			cs.totalamount += params.payment.amount;
			batch_collectionsheet.update(cs, "totalamount");

			itm = [
				objid: params.payment.objid,
				parentid: params.collectionsheet.detailid,
				refno: params.payment.refno,
				paytype: params.payment.type,
				payamount: params.payment.amount
			];
			batch_collectionsheet.create(itm, "payment");
		}
	}

	@ProxyMethod
	public void postNote( params ) {
		if (!params.note) throw new Exception("Please specify note.");
		postCollectionSheet(params);

		def itm = batch_collectionsheet.read(params.note, "note");
		if (!itm) {
			itm = [
				objid: params.note.objid,
				parentid: params.collectionsheet.detailid,
				fromdate: params.note.fromdate,
				todate: params.note.todate,
				remarks: params.note.remarks
			];
			batch_collectionsheet.create(itm, "note");
		}
	}

	private void postCollectionSheet( params ) {
		if (!params.sessionid) throw new Exception("Please specify sessionid.");
		params.totalcount = 0;
		params.totalamount = 0;
		println 'params = '+params
		device_billing.createBatchCollectionSheetHeader(params);
		def cs = batch_collectionsheet.read([objid: params.sessionid]);
		if (!cs) throw new Exception("Collection sheet does not exist or has already been deleted.");

		def itm = batch_collectionsheet.read([objid: params.collectionsheet.detailid], "detail");
		if (!itm) {
			cs.totalcount++;
			batch_collectionsheet.update(cs, "totalcount");
		}
		device_billing.createBatchCollectionSheetDetail(params);
	}

	@ProxyMethod
	public void updateNote( params ) {
		batch_collectionsheet.update(params.note, "note");
	}

	@ProxyMethod
	public void removeNote( params ) {
		batch_collectionsheet.delete([objid: params.noteid], "note");
	}

	@ProxyMethod
	public void updateRemarks( params ) {
		if (!params.collectionsheet) throw new Exception("Please specify collection sheet.");
		postCollectionSheet(params)
		def cs = batch_collectionsheet.read([objid: params.collectionsheet.detailid] ,"detail");
		if (!cs) throw new Exception("Collection sheet does not exist or has already been deleted.");

		cs.remarks = params.remarks;
		batch_collectionsheet.update(cs, "detail");
	}

	@ProxyMethod
	public void removeRemarks( params ) {
		if (!params.detailid) throw new Exception("Please specify detailid.");
		def cs = batch_collectionsheet.read([objid: params.detailid], "detail");
		if (!cs) throw new Exception("Collection sheet does not exist or has already been deleted.");

		cs.remarks = null;
		batch_collectionsheet.update(cs, "detail");
	}

	@ProxyMethod
	public boolean isVoidPaymentApproved( params ) {
		def itm = void_payment.read([objid: params.voidid]);
		if (!itm) throw new Exception("Void payment record does not exist or has already been deleted.");

		return (itm.state == 'APPROVED')? true : false;
	}

	@ProxyMethod
	public def voidPayment( params ) {
		if (!params.paymentid) throw new Exception("Please specify paymentid.");
		if (!params.loanappid) throw new Exception("Please specify loanappid.");

		def itm = [
			objid: params.objid,
			state: 'PENDING',
			paymentid: params.paymentid,
			routecode: params.routecode,
			loanappid: params.loanappid,
			collectorid: params.collectorid,
			reason: params.reason
		]
		void_payment.create(itm);
	}
}