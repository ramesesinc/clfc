import com.rameses.annotations.*;
import com.rameses.common.*;
import com.rameses.services.extended.*;
import java.rmi.server.UID;

class LoanAppService 
{	
	@ActiveDB(value='loanapp')
	def loanapp;

	@Service('DateService') 
	def dateService;

	@Env 
	def env;

	@ProxyMethod(local=true) 
	public def getEm() { return loanapp; } 	

	@ProxyMethod 
	public def open( params ) {
		def data = findByObjid(params); 
		if (!data) throw new Exception('\''+params.objid+'\' loan application record not found');

		return data;
	}

	@ProxyMethod 
	public def update( params ) {
		def data = findByObjid(params); 
		if (!data) throw new Exception('\''+params.objid+'\' loan application record not found');

		loanapp.update(params);
		loanapp.update(params, 'route')
		return params;
	} 


	@ProxyMethod(local=true) 
	public def findByObjid( params ) {
		return loanapp.findByObjid(params); 
	} 

	@ProxyMethod(local=true) 
	public void updateBorrowerIndices(loanappid, list) { 
		def data = findByObjid([objid: loanappid]); 
		loanapp.removeBorrowerIndices([loanappid: data.objid]); 
		for (o in list) {
			o.objid = 'BIDX' + new UID();
			o.loanappid = data.objid;
			o.loanappno = data.appno;
			loanapp.create(o, 'borrower_index'); 
		}

		data.branchcode = data.branch.code;
		data.branchname = data.branch.name;
		data.routecode = data.route?.code;
		data.fullborrowername = list.collect{ it.borrowername }.join(' AND '); 

		def si = loanapp.findSearchIndex([objid: data.objid]);
		if (si == null) { 
			data.dtposted = data.dtcreated;
			data.postedby = data.createdby;
			loanapp.create(data, 'search_index');
		} else {
			loanapp.update(data, 'search_index');
		}
	}

	@ProxyMethod 
	public def submitForInspection( params ) {
		if (!params.objid) throw new Exception('Please specify objid');
		if (!params.remarks) throw new Exception('Please specify remarks');

		def data = loanapp.findByObjid(params);
		if (data.state != 'PENDING') 
			throw new Exception('Loan status must be PENDING before submitting for inspection'); 

		data.dtposted = dateService.serverDate.toString(); 
		data.postedby = env.USERID; 
		data.state = 'FOR_INSPECTION';
		loanapp.update(data); 

		def o = loanapp.findSearchIndex(data); 
		o.state = data.state; 
		o.dtposted = data.dtposted;
		o.postedby = data.postedby;
		loanapp.update(o, 'search_index'); 
		loanapp.removeRecommendation(data); 

		o = [
			objid: 		'LOG' + new UID(),
			loanappid: 	data.objid, 
			dtposted: 	data.dtposted,
			postedby:  	data.postedby,
			remarks: 	params.remarks 
		];
		loanapp.create(o, 'log'); 
		return data; 
	} 

	@ProxyMethod 
	public def submitForCrecom( params ) {
		if (!params.objid) throw new Exception('Please specify objid');
		if (!params.remarks) throw new Exception('Please specify remarks');
		if (!params.ciremarks) throw new Exception('Please specify ciremarks');

		def data = loanapp.findByObjid(params);
		if (data.state != 'FOR_INSPECTION') 
			throw new Exception('Loan status must be FOR_INSPECTION before submitting for CRECOM'); 

		data.dtposted = dateService.serverDate.toString(); 
		data.postedby = env.USERID; 
		data.state = 'FOR_CRECOM';
		loanapp.update(data); 

		def o = loanapp.findSearchIndex(data); 
		o.state = data.state; 
		o.dtposted = data.dtposted;
		o.postedby = data.postedby;
		loanapp.update(o, 'search_index'); 
		loanapp.removeRecommendation(data); 

		o = [objid: data.objid, ciremarks: params.ciremarks];
		loanapp.create(o, 'ci_recommendation'); 

		o = [
			objid: 		'LOG' + new UID(),
			loanappid: 	data.objid, 
			dtposted: 	data.dtposted, 
			postedby:  	data.postedby,
			remarks: 	params.remarks 
		];
		loanapp.create(o, 'log'); 
		return data; 
	}	

	@ProxyMethod 
	public def returnForCI( params ) {
		if (!params.objid) throw new Exception('Please specify objid');
		if (!params.remarks) throw new Exception('Please specify remarks');

		def data = loanapp.findByObjid(params);
		if (data.state != 'FOR_CRECOM') 
			throw new Exception('Loan status must be FOR_CRECOM before submitting back for inspection'); 

		data.dtposted = dateService.serverDate.toString(); 
		data.postedby = env.USERID; 
		data.state = 'FOR_INSPECTION';
		loanapp.update(data); 

		def o = loanapp.findSearchIndex(data); 
		o.state = data.state; 
		o.dtposted = data.dtposted;
		o.postedby = data.postedby;
		loanapp.update(o, 'search_index'); 
		loanapp.removeRecommendation(data);

		o = [
			objid: 		'LOG' + new UID(),
			loanappid: 	data.objid, 
			dtposted: 	data.dtposted,
			postedby:  	data.postedby,
			remarks: 	params.remarks 
		];
		loanapp.create(o, 'log'); 
		return data; 
	} 	

	@ProxyMethod 
	public def submitForApproval( params ) {
		if (!params.objid) throw new Exception('Please specify objid');
		if (!params.remarks) throw new Exception('Please specify remarks');

		def data = loanapp.findByObjid(params);
		if (data.state != 'FOR_CRECOM') 
			throw new Exception('Loan status must be FOR_CRECOM before submitting for approval'); 

		data.dtposted = dateService.serverDate.toString(); 
		data.postedby = env.USERID; 
		data.state = 'FOR_APPROVAL'; 		
		loanapp.update(data); 

		def o = loanapp.findSearchIndex(data); 
		o.state = data.state; 
		o.dtposted = data.dtposted; 
		o.postedby = data.postedby;
		loanapp.update(o, 'search_index'); 

		o = loanapp.findRecommendation(data); 
		if (o == null) throw new Exception('Unable to find previous recommandation. Please check!'); 

		o.crecomremarks  = 	params.crecomremarks;
		o.marketeramount = 	params.marketeramount;
		o.ciamount 		 = 	params.ciamount;
		o.fcaamount 	 = 	params.fcaamount;
		o.caoamount 	 = 	params.caoamount;
		o.bcohamount 	 = 	params.bcohamount;
		loanapp.update(o, 'crecom_recommendation'); 

		o = [
			objid: 		'LOG' + new UID(),
			loanappid: 	data.objid, 
			dtposted: 	data.dtposted, 
			postedby:  	data.postedby,
			remarks: 	params.remarks 
		]; 
		loanapp.create(o, 'log'); 
		return data; 
	}		
} 